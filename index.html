<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QCM Culture Incendie - Diagnostic</title>

  <style>
    :root { 
      --card-bg: rgba(255,255,255,0.96); 
      --accent: #111;
      --sncf-blue: #0088ce;
      --border: rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0; min-height: 100vh; color: #111; background: #0f1115;
    }
    .bg {
      position: fixed; inset: 0;
      background-image: url("regiolis.jpg");
      background-size: cover; background-position: center;
      z-index: -3; pointer-events: none;
    }
    .overlay {
      position: fixed; inset: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0.7), rgba(0,0,0,0.5));
      z-index: -2; pointer-events: none;
    }
    .container { max-width: 800px; margin: 0 auto; padding: 20px 15px; position: relative; z-index: 1; }
    h1 { color: #fff; font-size: 1.6rem; text-align: center; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .muted { color: rgba(255,255,255,0.9); text-align: center; font-size: 0.9rem; margin-bottom: 20px; }
    .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    label { font-weight: 700; display: block; margin-bottom: 5px; margin-top: 10px; }
    input[type="text"], select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 1rem; margin-bottom: 10px; }
    button { width: 100%; padding: 14px; border-radius: 10px; border: none; background: var(--accent); color: #fff; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 10px; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    button.secondary { background: #fff; color: #111; border: 1px solid #ccc; }
    .pill { background: #eee; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; }
    progress { width: 100%; height: 10px; margin: 15px 0; border-radius: 5px; }
    #questionText { font-size: 1.25rem; font-weight: 800; line-height: 1.3; margin: 15px 0; }
    .options label { display: flex; align-items: center; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: background 0.2s; }
    .options label:hover { background: #f9f9f9; }
    .options input { transform: scale(1.3); margin-right: 12px; }
    .danger { color: #d32f2f; font-weight: 700; }
    .ok { color: #2e7d32; font-weight: 700; text-align: center; }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="overlay"></div>

  <div class="container">
    <h1>QCM Culture Incendie</h1>
    <p class="muted">30 questions ‚Ä¢ 15 secondes par question</p>

    <div id="startCard" class="card">
      <label>Service d‚Äôorigine (obligatoire)</label>
      <select id="serviceOrigin">
        <option value="">‚Äî S√©lectionner ‚Äî</option>
        <option value="Escale">Escale</option>
        <option value="Vente / Accueil">Vente / Accueil</option>
        <option value="ASCT">ASCT</option>
        <option value="Conducteur">Conducteur</option>
        <option value="S√ªret√©">S√ªret√©</option>
        <option value="Maintenance / Technique">Maintenance / Technique</option>
        <option value="Gares & Connexions">Gares & Connexions</option>
        <option value="Autre">Autre</option>
      </select>
      <div id="otherServiceWrap" style="display:none;">
        <input id="serviceOther" type="text" placeholder="Pr√©cisez votre service" />
      </div>

      <label>Nom / Pr√©nom (facultatif)</label>
      <input id="lastName" type="text" placeholder="Nom" />
      <input id="firstName" type="text" placeholder="Pr√©nom" />

      <button id="startBtn">D√©marrer le diagnostic (15s)</button>
      <p id="startWarn" class="danger" style="display:none; text-align:center;">
        Veuillez s√©lectionner votre service.
      </p>
    </div>

    <div id="quizCard" class="card" style="display:none;">
      <div style="display:flex; justify-content: space-between;">
        <span class="pill">Q <span id="qIndex">1</span>/30</span>
        <span class="pill">Chrono: <span id="timeLeft">15</span>s</span>
      </div>
      <progress id="progress" value="0" max="15"></progress>
      <div id="questionText">...</div>
      <div id="options" class="options"></div>
      <button id="nextBtn" disabled>Valider & Suivant</button>
      <button id="skipBtn" class="secondary">Passer</button>
    </div>

    <div id="finalCard" class="card" style="display:none;">
      <h2>Diagnostic termin√©</h2>
      <label>Un retour √† nous faire ? (optionnel)</label>
      <textarea id="freeText"></textarea>
      <button id="sendBtn">Envoyer mes r√©sultats</button>
      <p id="sendStatus" style="text-align:center; font-weight:bold;"></p>
    </div>

    <div id="doneCard" class="card" style="display:none;">
      <h2 class="ok">R√©sultats envoy√©s</h2>
      <p style="text-align:center;">Merci pour votre participation.</p>
    </div>
  </div>

<script>
const APPS_SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbx0kqt1t0nhy3DVU6iJ4vQT4vDLfv_Gz7Jdoha3Ydx-FZdK8KAhdmQa73A3_VTMPt6xKA/exec";

const TIME_LIMIT = 15;

/* QUESTIONS ‚Äì inchang√©es */
const QUESTIONS = [...]; // <-- garde exactement ton tableau QUESTIONS existant ici

const $ = id => document.getElementById(id);
let idx=0, timer=null, timeLeft=TIME_LIMIT, answers=[];
const resp={service:"",last:"",first:""};

function renderQuestion(){
  const q=QUESTIONS[idx];
  $("qIndex").textContent=idx+1;
  $("questionText").textContent=q.text;
  $("options").innerHTML="";
  q.options.forEach((opt,i)=>{
    const l=document.createElement("label");
    l.innerHTML=`<input type="radio" name="quizOpt" value="${i}"> ${opt}`;
    $("options").appendChild(l);
  });
  $("nextBtn").disabled=true;
  $("options").onchange=()=>$("nextBtn").disabled=false;
  resetTimer();
}

function resetTimer(){
  clearInterval(timer);
  timeLeft=TIME_LIMIT;
  $("timeLeft").textContent=timeLeft;
  $("progress").value=0;
  timer=setInterval(()=>{
    timeLeft--;
    $("timeLeft").textContent=timeLeft;
    $("progress").value=TIME_LIMIT-timeLeft;
    if(timeLeft<=0){commitAnswer(true);nextQuestion();}
  },1000);
}

function commitAnswer(timedOut=false){
  const radios=document.getElementsByName("quizOpt");
  let selected=null;
  for(const r of radios){if(r.checked)selected=parseInt(r.value);}
  answers.push({selected,isCorrect:selected===QUESTIONS[idx].correctIndex,timedOut});
}

function nextQuestion(){
  idx++;
  if(idx>=QUESTIONS.length){
    clearInterval(timer);
    $("quizCard").style.display="none";
    $("finalCard").style.display="block";
  } else renderQuestion();
}

$("serviceOrigin").onchange=()=>{
  $("otherServiceWrap").style.display =
    $("serviceOrigin").value==="Autre"?"block":"none";
};

$("startBtn").onclick=()=>{
  const s=$("serviceOrigin").value;
  if(!s){$("startWarn").style.display="block";return;}
  resp.service=s==="Autre"?$("serviceOther").value:s;
  resp.last=$("lastName").value;
  resp.first=$("firstName").value;
  $("startCard").style.display="none";
  $("quizCard").style.display="block";
  renderQuestion();
};

$("nextBtn").onclick=()=>{commitAnswer(false);nextQuestion();};
$("skipBtn").onclick=()=>{commitAnswer(false);nextQuestion();};

/* üî• ENVOI COMPATIBLE POSTE SNCF */
$("sendBtn").onclick=()=>{
  $("sendBtn").disabled=true;
  $("sendStatus").textContent="Envoi des r√©sultats‚Ä¶";

  const payload={
    submittedAtISO:new Date().toISOString(),
    service:resp.service,
    nom:resp.last+" "+resp.first,
    score:answers.filter(a=>a.isCorrect).length+"/30",
    details:JSON.stringify(answers),
    freeText:$("freeText").value,
    userAgent:navigator.userAgent
  };

  try{
    fetch(APPS_SCRIPT_URL,{
      method:"POST",
      body:JSON.stringify(payload),
      mode:"no-cors"
    });
  }catch(e){}

  $("finalCard").style.display="none";
  $("doneCard").style.display="block";
};
</script>
</body>
</html>
