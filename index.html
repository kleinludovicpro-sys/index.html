<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>QCM Culture Incendie - Diagnostic</title>

<style>
  :root { --card-bg: rgba(255,255,255,0.96); --accent:#111; --border: rgba(0,0,0,0.12); }
  *{box-sizing:border-box}
  body{margin:0; min-height:100vh; font-family:system-ui,-apple-system,sans-serif; background:#0f1115; color:#111;}
  .bg{position:fixed; inset:0; background:url("regiolis.jpg") center/cover no-repeat; z-index:-3;}
  .overlay{position:fixed; inset:0; background:linear-gradient(180deg,rgba(0,0,0,.75),rgba(0,0,0,.55)); z-index:-2;}
  .container{max-width:800px; margin:0 auto; padding:20px 15px; position:relative; z-index:1;}
  h1{color:#fff; text-align:center; margin:10px 0 5px; text-shadow:0 2px 4px rgba(0,0,0,.5);}
  .muted{color:rgba(255,255,255,.9); text-align:center; margin:0 0 20px; font-size:.95rem;}
  .card{background:var(--card-bg); border-radius:16px; padding:20px; margin-bottom:15px; box-shadow:0 10px 25px rgba(0,0,0,.3);}
  label{font-weight:800; display:block; margin:10px 0 5px;}
  input[type="text"], select, textarea{width:100%; padding:12px; border-radius:10px; border:1px solid var(--border); font-size:1rem;}
  textarea{min-height:90px; resize:vertical;}
  button{width:100%; padding:14px; border-radius:12px; border:none; background:var(--accent); color:#fff; font-weight:800; font-size:1rem; cursor:pointer; margin-top:12px;}
  button:disabled{opacity:.45; cursor:not-allowed;}
  .danger{color:#d32f2f; font-weight:800; text-align:center; margin-top:10px;}
  .pill{display:inline-block; background:#eee; padding:6px 12px; border-radius:20px; font-weight:800; font-size:.9rem;}
  .options label{display:flex; gap:10px; align-items:center; padding:12px; border:1px solid #ddd; border-radius:12px; margin:10px 0; cursor:pointer;}
  .options input{transform:scale(1.25);}
  .ok{color:#2e7d32; font-weight:900; text-align:center;}
</style>
</head>

<body>
<div class="bg"></div>
<div class="overlay"></div>

<div class="container">
  <h1>QCM Culture Incendie</h1>
  <p class="muted">30 questions â€¢ 15 secondes par question</p>

  <!-- START -->
  <div id="startCard" class="card">
    <label>Service dâ€™origine (obligatoire)</label>
    <select id="serviceOrigin">
      <option value="">â€” SÃ©lectionner â€”</option>
      <option value="Escale">Escale</option>
      <option value="Vente / Accueil">Vente / Accueil</option>
      <option value="ASCT">ASCT</option>
      <option value="Conducteur">Conducteur</option>
      <option value="SÃ»retÃ©">SÃ»retÃ©</option>
      <option value="Maintenance / Technique">Maintenance / Technique</option>
      <option value="Gares & Connexions">Gares & Connexions</option>
      <option value="Autre">Autre</option>
    </select>

    <div id="otherServiceWrap" style="display:none; margin-top:10px;">
      <input id="serviceOther" type="text" placeholder="PrÃ©cisez votre service" />
    </div>

    <label>Nom (obligatoire)</label>
    <input id="lastName" type="text" placeholder="Nom" />

    <label>PrÃ©nom (obligatoire)</label>
    <input id="firstName" type="text" placeholder="PrÃ©nom" />

    <button id="startBtn">DÃ©marrer le diagnostic</button>
    <p id="startWarn" class="danger" style="display:none;">
      Service + Nom + PrÃ©nom obligatoires.
    </p>
  </div>

  <!-- QUIZ -->
  <div id="quizCard" class="card" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <span class="pill">Q <span id="qIndex">1</span>/30</span>
      <span class="pill">Chrono: <span id="timeLeft">15</span>s</span>
    </div>
    <progress id="progress" value="0" max="15" style="width:100%; height:10px; margin:15px 0;"></progress>
    <div id="questionText" style="font-size:1.2rem; font-weight:900; margin:10px 0 10px;">...</div>
    <div id="options" class="options"></div>
    <button id="nextBtn" disabled>Valider & Suivant</button>
    <button id="skipBtn" style="background:#fff; color:#111; border:1px solid #ccc;">Passer</button>
  </div>

  <!-- FIN -->
  <div id="finalCard" class="card" style="display:none;">
    <h2 style="margin:0 0 10px;">Diagnostic terminÃ©</h2>
    <label>Un retour Ã  nous faire ? (optionnel)</label>
    <textarea id="freeText" placeholder="DifficultÃ©s, points flous..."></textarea>
    <button id="sendBtn">Envoyer mes rÃ©sultats</button>
    <p id="sendStatus" style="text-align:center; font-weight:800;"></p>
  </div>

  <div id="doneCard" class="card" style="display:none;">
    <h2 class="ok">âœ… RÃ©sultats envoyÃ©s</h2>
    <p style="text-align:center;">Merci pour votre participation.</p>
  </div>
</div>

<script>
  // âš ï¸ garde ton URL Apps Script (celle de ton 1er QCM)
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx0kqt1t0nhy3DVU6iJ4vQT4vDLfv_Gz7Jdoha3Ydx-FZdK8KAhdmQa73A3_VTMPt6xKA/exec";
  const TIME_LIMIT = 15;

  // âœ… TES 30 QUESTIONS Dâ€™ORIGINE (complÃ¨tes)
  const QUESTIONS = [
    { id:"Q1", text:"Quâ€™est-ce qui dÃ©finit un incendie ?", options:["Un feu visible","Une combustion non maÃ®trisÃ©e","Toute Ã©mission de fumÃ©e","Hausse de tempÃ©rature"], correctIndex:1 },
    { id:"Q2", text:"Ã‰lÃ©ment ajoutÃ© au triangle du feu pour le tÃ©traÃ¨dre :", options:["Pression","Radicaux libres","Ã‰lectricitÃ©","Carburant"], correctIndex:1 },
    { id:"Q3", text:"Supprimer un Ã©lÃ©ment du tÃ©traÃ¨dre entraÃ®ne :", options:["Ralentissement","Extinction","Explosion","Baisse de fumÃ©es"], correctIndex:1 },
    { id:"Q4", text:"MontÃ©e des fumÃ©es chaudes au plafond :", options:["Conduction","Rayonnement","Convection","Diffusion"], correctIndex:2 },
    { id:"Q5", text:"Danger principal des fumÃ©es :", options:["Invisibles","Surtout CO2","Toxiques, chaudes et sans O2","SSI"], correctIndex:2 },
    { id:"Q6", text:"Le CO est dangereux car :", options:["Visible","Incolore/inodore et mortel","Explose vite","Sans effet debout"], correctIndex:1 },
    { id:"Q7", text:"Un feu maÃ®trisable EPI est :", options:["GÃ©nÃ©ralisÃ©","Naissant, sans propagation","Ã‰pais","DerriÃ¨re porte chaude"], correctIndex:1 },
    { id:"Q8", text:"PrioritÃ© absolue en gare :", options:["Ã‰teindre","SÃ©curitÃ© des personnes","Sauver matÃ©riel","Limiter retards"], correctIndex:1 },
    { id:"Q9", text:"Ã‰touffer un feu c'est :", options:["Refroidir","Supprimer combustible","Couper l'oxygÃ¨ne","Courant d'air"], correctIndex:2 },
    { id:"Q10", text:"Phase auto-entretenue :", options:["Inflammation","Combustion entretenue","Refroidissement","Condensation"], correctIndex:1 },
    { id:"Q11", text:"RÃ¨gle face aux fumÃ©es (non Ã©quipÃ©) :", options:["Identifier foyer","Approcher","Ne pas s'exposer, alerter","Ventiler"], correctIndex:2 },
    { id:"Q12", text:"Ouvrir brutalement une porte en feu :", options:["Ã‰teint le feu","Appel d'air / aggravation","Coupe Ã©lectricitÃ©","DÃ©sactive dÃ©tecteurs"], correctIndex:1 },
    { id:"Q13", text:"La levÃ©e de doute sert Ã  :", options:["Ã‰teindre","Confirmer le sinistre","RÃ©armer SSI","Ã‰vacuer tout"], correctIndex:1 },
    { id:"Q14", text:"Principe en levÃ©e de doute :", options:["Sortir victimes","Extincteur prÃ©ventif","Ne jamais s'exposer au danger","Attendre"], correctIndex:2 },
    { id:"Q15", text:"Qui rÃ©arme le SSI aprÃ¨s fausse alarme ?", options:["Le CEV","Tout le monde","Mainteneur seulement","Public"], correctIndex:0 },
    { id:"Q16", text:"DÃ©part feu non maÃ®trisable confirmÃ© :", options:["Continuer seul","Alerte + sÃ©curitÃ© + accueil","RÃ©armer","Prendre ascenseur"], correctIndex:1 },
    { id:"Q17", text:"Alerte immÃ©diate 18/112 si :", options:["Simple doute","Odeur lÃ©gÃ¨re","FumÃ©es/feu/propagation","DM dÃ©clenchÃ©"], correctIndex:2 },
    { id:"Q18", text:"Info utile aux secours :", options:["Cause probable","Lieu + Ã‰tendue/propagation","Nom chef de gare","Retards trains"], correctIndex:1 },
    { id:"Q19", text:"RÃ´le du CEV pour les pompiers :", options:["Diriger","Interlocuteur site / infos","Exploitation","Intervenir"], correctIndex:1 },
    { id:"Q20", text:"Suspicion de gaz :", options:["LumiÃ¨res","TÃ©lÃ©phone zone","Mise en sÃ©curitÃ©, alerter","Chercher fuite"], correctIndex:2 },
    { id:"Q21", text:"Risque Ã©lectrique BV :", options:["Toucher armoires","Coupure immÃ©diate","Ã‰viter zone / prÃ©venir","Eau"], correctIndex:2 },
    { id:"Q22", text:"Extincteur eau pulvÃ©risÃ©e :", options:["Solides (A)","MÃ©taux","Gaz","Tout"], correctIndex:0 },
    { id:"Q23", text:"Extincteur CO2 :", options:["Classe A","Ã‰lectrique / liquides","Gaz","MÃ©taux"], correctIndex:1 },
    { id:"Q24", text:"Extincteur poudre :", options:["Refroidir","Couper rÃ©action chimique","FumÃ©es","Projections"], correctIndex:1 },
    { id:"Q25", text:"Danger majeur local fermÃ© :", options:["Distance","Tester porte","Ouvrir grand pour voir","Alerter"], correctIndex:2 },
    { id:"Q26", text:"Point de rassemblement :", options:["Pause","Recenser / centraliser","Observer","Attendre"], correctIndex:1 },
    { id:"Q27", text:"Guide/serre-file :", options:["Ã‰teindre","Organiser Ã©vacuation","Remplacer pompiers","Billets"], correctIndex:1 },
    { id:"Q28", text:"PrioritÃ© victime :", options:["Cause","SÃ©curitÃ© + Alerte + Gestes","Exploitation","Photos"], correctIndex:1 },
    { id:"Q29", text:"Fin de sinistre relÃ¨ve de :", options:["Public","Pompier (oral)","ResponsabilitÃ© SNCF","Appelant"], correctIndex:2 },
    { id:"Q30", text:"But du QCM :", options:["Sanctionner","Habiliter","Mesurer niveau initial","Remplacer pratique"], correctIndex:2 }
  ];

  const $ = (id) => document.getElementById(id);

  let idx = 0;
  let timer = null;
  let timeLeft = TIME_LIMIT;
  const answers = []; // {id, selected, isCorrect, timedOut}
  const resp = { service:"", last:"", first:"" };

  function renderQuestion() {
    const q = QUESTIONS[idx];
    $("qIndex").textContent = idx + 1;
    $("questionText").textContent = q.text;

    const container = $("options");
    container.innerHTML = "";
    q.options.forEach((opt, i) => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="radio" name="quizOpt" value="${i}"> ${opt}`;
      container.appendChild(label);
    });

    $("nextBtn").disabled = true;
    container.onchange = () => { $("nextBtn").disabled = false; };
    resetTimer();
  }

  function resetTimer() {
    clearInterval(timer);
    timeLeft = TIME_LIMIT;
    $("timeLeft").textContent = timeLeft;
    $("progress").value = 0;

    timer = setInterval(() => {
      timeLeft--;
      $("timeLeft").textContent = timeLeft;
      $("progress").value = TIME_LIMIT - timeLeft;
      if (timeLeft <= 0) {
        commitAnswer(true);
        nextQuestion();
      }
    }, 1000);
  }

  function commitAnswer(timedOut = false) {
    const q = QUESTIONS[idx];
    const radios = document.getElementsByName("quizOpt");
    let selected = null;
    for (const r of radios) {
      if (r.checked) selected = parseInt(r.value, 10);
    }
    answers.push({
      id: q.id,
      selected,
      isCorrect: selected === q.correctIndex,
      timedOut
    });
  }

  function nextQuestion() {
    idx++;
    if (idx >= QUESTIONS.length) {
      clearInterval(timer);
      $("quizCard").style.display = "none";
      $("finalCard").style.display = "block";
    } else {
      renderQuestion();
    }
  }

  $("serviceOrigin").onchange = () => {
    $("otherServiceWrap").style.display = ($("serviceOrigin").value === "Autre") ? "block" : "none";
  };

  $("startBtn").onclick = () => {
    const s = $("serviceOrigin").value;
    const last = $("lastName").value.trim();
    const first = $("firstName").value.trim();
    const other = $("serviceOther").value.trim();

    // Obligatoires
    if (!s || !last || !first || (s === "Autre" && !other)) {
      $("startWarn").style.display = "block";
      return;
    }
    $("startWarn").style.display = "none";

    resp.service = (s === "Autre") ? other : s;
    resp.last = last;
    resp.first = first;

    $("startCard").style.display = "none";
    $("quizCard").style.display = "block";
    renderQuestion();
  };

  $("nextBtn").onclick = () => { commitAnswer(false); nextQuestion(); };
  $("skipBtn").onclick = () => { commitAnswer(false); nextQuestion(); };

  // ðŸ”¥ Envoi compatible poste SNCF : pas d'attente rÃ©seau
  $("sendBtn").onclick = () => {
    $("sendBtn").disabled = true;
    $("sendStatus").textContent = "Envoi des rÃ©sultatsâ€¦";

   const payload = {
  submittedAtISO: new Date().toISOString(),
  startedAtISO: "",                 // optionnel (si tu ne lâ€™as pas)
  durationSeconds: "",              // optionnel (si tu ne lâ€™as pas)

  serviceOrigin: resp.service,      // âœ… attendu par Apps Script
  lastName: resp.last,              // âœ… attendu
  firstName: resp.first,            // âœ… attendu

  totalQuestions: QUESTIONS.length, // âœ… attendu
  answeredCount: answers.filter(a => a.selected !== null).length, // âœ… attendu
  correctCount: answers.filter(a => a.isCorrect).length,          // âœ… attendu

  freeText: $("freeText").value,    // âœ… attendu

  answers: answers,                 // âœ… attendu (et non "details")
};


    try {
      fetch(APPS_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(payload)
      });
    } catch (e) {
      // volontairement ignorÃ©
    }

    $("finalCard").style.display = "none";
    $("doneCard").style.display = "block";
  };
</script>
</body>
</html>
