<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QCM Culture Incendie - Diagnostic</title>
  <style>
    :root { --card-bg: rgba(255,255,255,0.94); --border: rgba(255,255,255,0.35); }
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      color: #111;
      background: #0f1115;
    }

    /* Fond : mets une image "background-regiolis.jpg" √† c√¥t√© de index.html (optionnel) */
    .bg {
      position: fixed; inset: 0;
      background-image: url("./background-regiolis.jpg");
      background-size: cover;
      background-position: center;
      z-index: -3;
    }
    .overlay {
      position: fixed; inset: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0.72), rgba(0,0,0,0.55));
      z-index: -2;
    }

    .container {
      max-width: 980px;
      margin: 0 auto;
      padding: 22px 14px 40px;
    }

    h1, h2, h3 { margin: 0 0 10px; color: #fff; }
    p { margin: 8px 0; }

    .muted { color: rgba(255,255,255,0.86); font-size: 0.98rem; line-height: 1.35; }
    .danger { color: #ffb4b4; font-weight: 750; }
    .ok { color: #0a7a3f; font-weight: 750; }

    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin: 14px 0;
      background: var(--card-bg);
      backdrop-filter: blur(6px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
    }

    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }

    .pill {
      background: rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 750;
    }

    button {
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid #111;
      background: #111;
      color: #fff;
      cursor: pointer;
      font-weight: 750;
    }
    button.secondary { background: #fff; color: #111; border: 1px solid rgba(0,0,0,0.25); }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    label { font-weight: 750; }
    input[type="text"], select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.20);
      font-size: 1rem;
      background: #fff;
    }
    textarea { min-height: 120px; resize: vertical; }

    .options label {
      display: block;
      padding: 10px 10px;
      border: 1px solid rgba(0,0,0,0.14);
      border-radius: 12px;
      margin: 8px 0;
      cursor: pointer;
      background: rgba(255,255,255,0.92);
    }
    .options input { margin-right: 8px; }

    progress { width: 100%; height: 16px; border-radius: 999px; overflow: hidden; }

    .small { font-size: 0.92rem; color: #222; }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="overlay"></div>

  <div class="container">
    <h1>QCM Culture Incendie (diagnostic)</h1>
    <p class="muted">
      30 questions ‚Ä¢ <strong>30 secondes par question</strong> ‚Ä¢ objectif : √©tat des lieux de connaissances (culture EPI attendue).
    </p>
    <p class="muted">
      Service d‚Äôorigine obligatoire ‚Ä¢ Nom/Pr√©nom facultatifs ‚Ä¢ Pas de mail / pas de matricule
    </p>

    <!-- INTRO -->
    <div id="startCard" class="card">
      <p><strong>Consigne :</strong> r√©ponds spontan√©ment. Si le temps expire, la question est valid√©e ‚Äúsans r√©ponse‚Äù et on passe √† la suivante.</p>

      <div class="card" style="background: rgba(255,255,255,0.88); box-shadow:none;">
        <h3 style="margin-top:0;">Informations minimales</h3>

        <label for="serviceOrigin"><strong>Service d‚Äôorigine (obligatoire)</strong></label><br />
        <select id="serviceOrigin">
          <option value="">‚Äî S√©lectionner ‚Äî</option>
          <option value="Escale">Escale</option>
          <option value="Vente / Accueil">Vente / Accueil</option>
          <option value="ASCT">ASCT</option>
          <option value="Conducteur">Conducteur</option>
          <option value="S√ªret√©">S√ªret√©</option>
          <option value="Maintenance / Technique">Maintenance / Technique</option>
          <option value="Gares & Connexions">Gares & Connexions</option>
          <option value="Autre">Autre</option>
        </select>

        <div id="otherServiceWrap" style="display:none; margin-top:10px;">
          <label for="serviceOther">Pr√©ciser ‚ÄúAutre‚Äù (obligatoire si Autre)</label>
          <input id="serviceOther" type="text" placeholder="Ex : Propret√©, Logistique, Prestataire, etc." />
        </div>

        <div class="row" style="margin-top:12px;">
          <div style="flex:1; min-width:220px;">
            <label for="lastName">Nom (facultatif)</label><br />
            <input id="lastName" type="text" placeholder="Nom" />
          </div>
          <div style="flex:1; min-width:220px;">
            <label for="firstName">Pr√©nom (facultatif)</label><br />
            <input id="firstName" type="text" placeholder="Pr√©nom" />
          </div>
        </div>

        <p class="small" style="margin:10px 0 0;">
          Le service est requis pour l‚Äôanalyse statistique. Le nom/pr√©nom ne servent que si tu veux un retour individuel.
        </p>
      </div>

      <button id="startBtn" style="margin-top:12px;">D√©marrer</button>
      <p id="startWarn" class="danger" style="display:none; margin-top:10px;">
        Merci de s√©lectionner ton service (et pr√©ciser ‚ÄúAutre‚Äù si besoin).
      </p>
      <p id="startErr" class="danger" style="display:none; margin-top:10px;"></p>
    </div>

    <!-- QUIZ -->
    <div id="quizCard" class="card" style="display:none;">
      <div class="row">
        <div class="pill">Question <span id="qIndex">1</span>/<span id="qTotal">30</span></div>
        <div class="pill">Temps restant : <span id="timeLeft">30</span>s</div>
      </div>

      <progress id="progress" value="0" max="30"></progress>

      <h2 id="questionText" style="margin-top:14px;"></h2>
      <div id="options" class="options"></div>

      <div class="row" style="margin-top:12px;">
        <button id="nextBtn" disabled>Valider & suivant</button>
        <button id="skipBtn" class="secondary">Passer</button>
        <span id="warn" class="danger" style="display:none;">S√©lectionne une r√©ponse (ou ‚ÄúPasser‚Äù).</span>
      </div>
    </div>

    <!-- FINAL -->
    <div id="finalCard" class="card" style="display:none;">
      <h2>Expression libre (optionnel)</h2>
      <p class="small">
        Dis ce qui t‚Äôa manqu√©, ce qui t‚Äôa surpris, ou une difficult√© (situations v√©cues, points flous, besoins de formation).
      </p>
      <textarea id="freeText" placeholder="Ton retour (optionnel)"></textarea>

      <div class="row" style="margin-top:12px;">
        <button id="sendBtn">Envoyer</button>
        <button id="restartBtn" class="secondary">Recommencer</button>
        <span id="sendStatus" class="small"></span>
      </div>

      <p id="sendErr" class="danger" style="display:none; margin-top:10px;"></p>
    </div>

    <!-- DONE -->
    <div id="doneCard" class="card" style="display:none;">
      <h2>Merci üëç</h2>
      <p class="small">Tes r√©ponses ont √©t√© envoy√©es.</p>
      <p class="small ok">Tu peux fermer cette page.</p>
    </div>
  </div>

<script>
  // TON URL /exec
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzpaU90UOO57xoSLGu6T7yrBhwb0hp9CNFO76oQ4uQ-13MCYLt3KdHbk45sYbIpIYgV2Q/exec";

  const SECONDS_PER_QUESTION = 30;

  // 30 questions (diagnostic culture incendie / SSI / lev√©e de doute / accueil secours)
  const QUESTIONS = [
    { id:"Q1",  text:"Qu‚Äôest-ce qui d√©finit un incendie (culture incendie) ?", options:["Un feu visible produisant des flammes","Une combustion non ma√Ætris√©e dans le temps et l‚Äôespace","Toute √©mission de fum√©e dans un local","Une √©l√©vation anormale de temp√©rature"], correctIndex:1 },
    { id:"Q2",  text:"Dans le t√©tra√®dre du feu, l‚Äô√©l√©ment ajout√© au triangle classique est :", options:["La pression","Les radicaux libres","L‚Äô√©lectricit√©","Le carburant"], correctIndex:1 },
    { id:"Q3",  text:"Supprimer un seul des √©l√©ments du t√©tra√®dre du feu entra√Æne :", options:["Un ralentissement du feu","L‚Äôextinction du feu","Une explosion possible","Une baisse de fum√©es uniquement"], correctIndex:1 },
    { id:"Q4",  text:"La mont√©e des fum√©es chaudes au plafond correspond au mode de propagation :", options:["Conduction","Rayonnement","Convection","Diffusion"], correctIndex:2 },
    { id:"Q5",  text:"Pourquoi les fum√©es sont-elles souvent plus dangereuses que les flammes ?", options:["Parce qu‚Äôelles sont invisibles","Parce qu‚Äôelles sont surtout du CO‚ÇÇ","Parce qu‚Äôelles sont toxiques, chaudes et appauvrissent l‚Äôair en oxyg√®ne","Parce qu‚Äôelles d√©clenchent le SSI"], correctIndex:2 },
    { id:"Q6",  text:"Le monoxyde de carbone (CO) est particuli√®rement dangereux car :", options:["Il est toujours visible","Il est incolore/inodore et mortel","Il explose √† faible concentration","Il est sans effet si on est debout"], correctIndex:1 },
    { id:"Q7",  text:"Un feu ‚Äúma√Ætrisable‚Äù par un agent form√© EPI est plut√¥t :", options:["Un feu g√©n√©ralis√© au local","Un feu naissant, localis√©, sans propagation","Un feu avec fum√©es √©paisses","Un feu derri√®re une porte chaude"], correctIndex:1 },
    { id:"Q8",  text:"Priorit√© absolue lors d‚Äôun d√©part de feu en gare :", options:["√âteindre le feu","Mettre en s√©curit√© les personnes","Sauver le mat√©riel","Limiter le retard trains"], correctIndex:1 },
    { id:"Q9",  text:"Parmi ces m√©thodes, laquelle correspond √† ‚Äú√©touffer‚Äù un feu ?", options:["Refroidir avec eau","Supprimer le combustible","Couper l‚Äôapport de comburant (oxyg√®ne)","Cr√©er un courant d‚Äôair"], correctIndex:2 },
    { id:"Q10", text:"La phase o√π le feu devient ‚Äúauto-entretenu‚Äù est :", options:["Inflammation (d√©pend de la source)","Combustion entretenue (n‚Äôa plus besoin d‚Äôaide)","Refroidissement","Condensation"], correctIndex:1 },

    { id:"Q11", text:"En pr√©sence de fum√©es, la r√®gle la plus s√ªre pour un agent non √©quip√© ARI est :", options:["Rentrer vite pour identifier le foyer","S‚Äôapprocher pour confirmer l‚Äôodeur","Ne pas s‚Äôexposer : se replier et alerter","Ouvrir les fen√™tres pour ventiler"], correctIndex:2 },
    { id:"Q12", text:"Ouvrir brutalement une porte d‚Äôun local en feu peut :", options:["√âteindre le feu par d√©pression","Cr√©er un appel d‚Äôair et aggraver le feu","Couper l‚Äôalimentation √©lectrique","D√©sactiver les d√©tecteurs"], correctIndex:1 },
    { id:"Q13", text:"La ‚Äúlev√©e de doute‚Äù sert d‚Äôabord √† :", options:["√âteindre le feu","Confirmer/infirmer la r√©alit√© du sinistre","R√©armer le SSI","√âvacuer syst√©matiquement tout le b√¢timent"], correctIndex:1 },
    { id:"Q14", text:"Lors d‚Äôune lev√©e de doute, le bon principe de d√©cision est :", options:["Toujours entrer dans le local en alarme","Toujours utiliser un extincteur en pr√©vention","Ne jamais s‚Äôexposer √† un danger (fum√©es/chaleur/porte chaude)","Attendre les pompiers sans rien faire"], correctIndex:2 },
    { id:"Q15", text:"Le r√©armement / remise en √©tat d‚Äô√©l√©ments SSI rel√®ve :", options:["Du CEV","De l‚Äôagent le plus ancien","Du mainteneur habilit√©","De n‚Äôimporte quel agent form√© EPI"], correctIndex:2 },

    { id:"Q16", text:"Si l‚Äôalarme SSI se d√©clenche et que tu confirmes un d√©part de feu non ma√Ætrisable :", options:["Tu continues la lev√©e de doute seul","Tu fais priorit√© √† l‚Äôalerte + mise en s√©curit√© + accueil secours","Tu r√©armes pour arr√™ter la sonnerie","Tu prends l‚Äôascenseur pour aller voir"], correctIndex:1 },
    { id:"Q17", text:"Un crit√®re d‚Äôalerte ‚Äúimm√©diate‚Äù aux secours (18/112) est :", options:["Un simple doute sans signe","Une odeur l√©g√®re sans fum√©e","Fum√©es visibles / d√©part feu confirm√© / propagation possible","Un DM d√©clench√© puis silence"], correctIndex:2 },
    { id:"Q18", text:"Lors de l‚Äôappel aux secours, information la plus utile en plus du lieu :", options:["Ton avis sur la cause probable","L‚Äô√©tendue/propagation (ce qui br√ªle, fum√©es, victimes)","Le nom du chef de gare","Le nombre de trains en retard"], correctIndex:1 },
    { id:"Q19", text:"Accueil des sapeurs-pompiers : le r√¥le du CEV est plut√¥t :", options:["Diriger les pompiers","√ätre l‚Äôinterlocuteur site et transmettre infos/acc√®s","Rester au bureau pour g√©rer l‚Äôexploitation","Intervenir avec extincteur sur ordre"], correctIndex:1 },
    { id:"Q20", text:"En cas de suspicion de gaz (odeur, fuite), le bon r√©flexe est :", options:["Allumer/√©teindre les lumi√®res pour voir","Utiliser un t√©l√©phone dans la zone suspecte","√âloigner/mettre en s√©curit√© et alerter, √©viter sources d‚Äôignition","Chercher la fuite avec une flamme"], correctIndex:2 },

    { id:"Q21", text:"Le risque √©lectrique en intervention b√¢timent voyageurs impose surtout :", options:["De toucher les armoires pour sentir la chaleur","De consid√©rer que la coupure totale est toujours imm√©diate","De pr√©venir les secours et √©viter tout contact/zone dangereuse","D‚Äôutiliser de l‚Äôeau sur tout feu √©lectrique"], correctIndex:2 },
    { id:"Q22", text:"Un extincteur √† eau pulv√©ris√©e est g√©n√©ralement adapt√© √† :", options:["Feux de solides (papier/bois) principalement","Feux de m√©taux","Feux de gaz","Tous les feux sans exception"], correctIndex:0 },
    { id:"Q23", text:"Un extincteur CO‚ÇÇ est surtout pertinent pour :", options:["Feux de classe A (braises)","Feux d‚Äôorigine √©lectrique / liquides inflammables en petit volume","Feux de gaz sous pression","Feux de m√©taux"], correctIndex:1 },
    { id:"Q24", text:"Un extincteur poudre a comme int√©r√™t majeur :", options:["Refroidir tr√®s efficacement","Couper la r√©action en cha√Æne (effet chimique)","Faire retomber les fum√©es","√âviter la projection de braises"], correctIndex:1 },
    { id:"Q25", text:"Quel comportement est le plus dangereux face √† un feu dans un local ferm√© ?", options:["Se tenir √† distance","Tester la porte (chaleur) avant ouverture","Ouvrir grand imm√©diatement pour ‚Äúvoir‚Äù","Alerter et se prot√©ger"], correctIndex:2 },

    { id:"Q26", text:"Le point de rassemblement sert principalement √† :", options:["Faire une pause apr√®s l‚Äô√©vacuation","Compter/recenser et centraliser les informations","Se rapprocher du feu pour observer","Attendre les consignes sans communiquer"], correctIndex:1 },
    { id:"Q27", text:"Guide/serre-file : leur utilit√© principale est :", options:["√âteindre le feu en premier","Organiser l‚Äô√©vacuation et v√©rifier que personne ne reste derri√®re","Remplacer les pompiers","Contr√¥ler les billets"], correctIndex:1 },
    { id:"Q28", text:"Si tu identifies une victime (malaise/CO/fum√©es) pendant l‚Äô√©v√©nement, tu priorises :", options:["La recherche de la cause","La mise en s√©curit√© + alerte secours + gestes adapt√©s sans t‚Äôexposer","Le retour √† l‚Äôexploitation","La prise de photos pour REX"], correctIndex:1 },
    { id:"Q29", text:"La fin de sinistre / reprise d‚Äôexploitation rel√®ve :", options:["De la d√©cision du public","De la d√©cision ‚Äúorale‚Äù d‚Äôun sapeur-pompier sur place","D‚Äôune responsabilit√© hi√©rarchique/organisation SNCF (appui si besoin)","De l‚Äôagent qui a appel√© les secours"], correctIndex:2 },
    { id:"Q30", text:"Le but de ce QCM est avant tout :", options:["Sanctionner","Habiliter","Mesurer le niveau initial pour adapter la formation","Remplacer la formation pratique"], correctIndex:2 }
  ];

  const $ = (id) => document.getElementById(id);

  $("qTotal").textContent = String(QUESTIONS.length);

  let idx = 0;
  let timer = null;
  let timeLeft = SECONDS_PER_QUESTION;
  let answers = [];
  let startedAtISO = null;

  const respondent = { serviceOrigin:"", lastName:"", firstName:"" };

  function show(id) { $(id).style.display = "block"; }
  function hide(id) { $(id).style.display = "none"; }
  function text(id, t) { $(id).textContent = t; }

  $("serviceOrigin").addEventListener("change", () => {
    const v = $("serviceOrigin").value;
    if (v === "Autre") show("otherServiceWrap");
    else hide("otherServiceWrap");
  });

  function normalizeService() {
    const service = $("serviceOrigin").value;
    const other = ($("serviceOther").value || "").trim();
    if (service === "Autre") return other ? `Autre - ${other}` : "Autre";
    return service;
  }

  function resetTimer() {
    clearInterval(timer);
    timeLeft = SECONDS_PER_QUESTION;
    text("timeLeft", String(timeLeft));
    $("progress").max = SECONDS_PER_QUESTION;
    $("progress").value = 0;

    timer = setInterval(() => {
      timeLeft--;
      text("timeLeft", String(timeLeft));
      $("progress").value = SECONDS_PER_QUESTION - timeLeft;
      if (timeLeft <= 0) {
        clearInterval(timer);
        commitAnswer(true);
        nextQuestion();
      }
    }, 1000);
  }

  function renderQuestion() {
    const q = QUESTIONS[idx];
    text("qIndex", String(idx + 1));
    text("questionText", q.text);

    const optionsDiv = $("options");
    optionsDiv.innerHTML = "";

    q.options.forEach((opt, i) => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="radio" name="opt" value="${i}"> ${opt}`;
      optionsDiv.appendChild(label);
    });

    $("nextBtn").disabled = true;
    hide("warn");

    optionsDiv.addEventListener("change", () => {
      $("nextBtn").disabled = false;
      hide("warn");
    }, { once: true });

    resetTimer();
  }

  function getSelectedIndex() {
    const el = document.querySelector('input[name="opt"]:checked');
    return el ? Number(el.value) : null;
  }

  function commitAnswer(timedOut=false) {
    const q = QUESTIONS[idx];
    const selected = getSelectedIndex();
    const isCorrect = (selected !== null) ? (selected === q.correctIndex) : null;
    answers.push({ id:q.id, selectedIndex:selected, isCorrect, timedOut });
  }

  function nextQuestion() {
    idx++;
    if (idx >= QUESTIONS.length) {
      clearInterval(timer);
      hide("quizCard");
      show("finalCard");
      return;
    }
    renderQuestion();
  }

  function validateStart() {
    hide("startErr");
    hide("startWarn");

    if (!QUESTIONS || QUESTIONS.length !== 30) {
      text("startErr", "Erreur: la liste de questions n'est pas √† 30.");
      show("startErr");
      return false;
    }

    const service = $("serviceOrigin").value;
    const other = ($("serviceOther").value || "").trim();
    if (!service) { show("startWarn"); return false; }
    if (service === "Autre" && !other) { show("startWarn"); return false; }
    return true;
  }

  $("startBtn").addEventListener("click", () => {
    if (!validateStart()) return;

    respondent.serviceOrigin = normalizeService();
    respondent.lastName = ($("lastName").value || "").trim();
    respondent.firstName = ($("firstName").value || "").trim();

    startedAtISO = new Date().toISOString();

    hide("startCard");
    show("quizCard");
    idx = 0;
    answers = [];
    renderQuestion();
  });

  $("nextBtn").addEventListener("click", () => {
    clearInterval(timer);
    const sel = getSelectedIndex();
    if (sel === null) { show("warn"); return; }
    commitAnswer(false);
    nextQuestion();
  });

  $("skipBtn").addEventListener("click", () => {
    clearInterval(timer);
    commitAnswer(false);
    nextQuestion();
  });

  $("restartBtn").addEventListener("click", () => {
    hide("sendErr");
    text("sendStatus", "");
    $("sendBtn").disabled = false;
    $("freeText").value = "";
    hide("finalCard");
    show("startCard");
  });

  async function sendPayload(payload) {
    const res = await fetch(APPS_SCRIPT_URL, { method:"POST", body: JSON.stringify(payload) });
    const txt = await res.text();

    try {
      const j = JSON.parse(txt);
      if (j && j.ok) return { ok:true };
      return { ok:false, error: (j && j.error) ? j.error : "R√©ponse serveur non OK" };
    } catch (_) {
      return res.ok ? { ok:true } : { ok:false, error:"HTTP " + res.status };
    }
  }

  $("sendBtn").addEventListener("click", async () => {
    hide("sendErr");
    $("sendBtn").disabled = true;
    text("sendStatus", "Envoi en cours‚Ä¶");

    const answeredCount = answers.filter(a => a.selectedIndex !== null).length;
    const correctCount = answers.filter(a => a.isCorrect === true).length;

    const payload = {
      submittedAtISO: new Date().toISOString(),
      startedAtISO,
      durationSeconds: startedAtISO ? Math.round((Date.now() - Date.parse(startedAtISO)) / 1000) : "",

      serviceOrigin: respondent.serviceOrigin,
      lastName: respondent.lastName,
      firstName: respondent.firstName,

      totalQuestions: QUESTIONS.length,
      answeredCount,
      correctCount,

      answers,
      freeText: ($("freeText").value || "").trim()
    };

    try {
      const result = await sendPayload(payload);
      if (!result.ok) throw new Error(result.error || "Envoi refus√©");

      text("sendStatus", "Envoy√© ‚úÖ");
      hide("finalCard");
      show("doneCard");
    } catch (err) {
      text("sendStatus", "");
      $("sendBtn").disabled = false;
      text("sendErr", "√âchec de l‚Äôenvoi : " + (err && err.message ? err.message : String(err)));
      show("sendErr");
    }
  });
</script>
</body>
</html>
