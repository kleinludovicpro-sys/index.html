const SHEET_NAME = "Reponses";

const HEADERS = [
  "submittedAtISO",
  "startedAtISO",
  "durationSeconds",
  "serviceOrigin",
  "lastName",
  "firstName",
  "totalQuestions",
  "answeredCount",
  "correctCount",
  "freeText",
  "answersJSON"
];

function doGet() {
  return ContentService
    .createTextOutput("OK - endpoint actif")
    .setMimeType(ContentService.MimeType.TEXT);
}

function doPost(e) {
  try {
    if (!e || !e.postData || !e.postData.contents) {
      throw new Error("Aucune donnée reçue (postData vide).");
    }

    const data = JSON.parse(e.postData.contents);

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    if (!ss) {
      throw new Error("Classeur actif introuvable. Crée le script depuis le Google Sheet.");
    }

    const sheet = ss.getSheetByName(SHEET_NAME) || ss.insertSheet(SHEET_NAME);
    ensureHeaders_(sheet);

    sheet.appendRow([
      data.submittedAtISO || "",
      data.startedAtISO || "",
      data.durationSeconds || "",
      data.serviceOrigin || "",
      data.lastName || "",
      data.firstName || "",
      data.totalQuestions || "",
      data.answeredCount || "",
      data.correctCount || "",
      data.freeText || "",
      JSON.stringify(data.answers || [])
    ]);

    return jsonResponse_({ ok: true });

  } catch (err) {
    Logger.log("doPost ERROR: " + (err && err.stack ? err.stack : String(err)));
    return jsonResponse_({ ok: false, error: String(err) });
  }
}

function ensureHeaders_(sheet) {
  if (sheet.getLastRow() === 0) {
    sheet.appendRow(HEADERS);
    return;
  }

  const firstRow = sheet.getRange(1, 1, 1, Math.min(sheet.getLastColumn(), HEADERS.length)).getValues()[0];
  const looksLikeHeader = firstRow[0] === "submittedAtISO" && firstRow[3] === "serviceOrigin";

  if (!looksLikeHeader) {
    sheet.insertRowBefore(1);
    sheet.getRange(1, 1, 1, HEADERS.length).setValues([HEADERS]);
  }
}

function jsonResponse_(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
