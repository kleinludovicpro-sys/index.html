<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QCM Culture Incendie - SNCF</title>
  <style>
    :root { --card-bg: rgba(255,255,255,0.92); --border: rgba(255,255,255,0.35); }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      color: #111;
      background: #111;
    }

    /* Fond : image locale (mets ton fichier √† c√¥t√© de index.html) */
    .bg {
      position: fixed;
      inset: 0;
      background-image: url("./background-regiolis.jpg"); /* <- Mets ici ta photo Regiolis */
      background-size: cover;
      background-position: center;
      filter: blur(0px);
      transform: scale(1.02);
      z-index: -3;
    }
    /* Voile sombre pour lisibilit√© */
    .overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0.70), rgba(0,0,0,0.55));
      z-index: -2;
    }

    .container {
      max-width: 920px;
      margin: 0 auto;
      padding: 24px 14px 40px;
    }

    h1, h2, h3 { margin: 0 0 10px; color: #fff; }
    p { margin: 8px 0; }

    .muted { color: rgba(255,255,255,0.85); font-size: 0.98rem; line-height: 1.35; }
    .danger { color: #ffb4b4; font-weight: 650; }

    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin: 14px 0;
      background: var(--card-bg);
      backdrop-filter: blur(6px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
    }

    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }

    .pill {
      background: rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 650;
    }

    button {
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid #111;
      background: #111;
      color: #fff;
      cursor: pointer;
      font-weight: 650;
    }
    button.secondary { background: #fff; color: #111; border: 1px solid rgba(0,0,0,0.25); }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    label { font-weight: 650; }
    input[type="text"], select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.20);
      font-size: 1rem;
      background: #fff;
    }
    textarea { min-height: 120px; resize: vertical; }

    .options label {
      display: block;
      padding: 10px 10px;
      border: 1px solid rgba(0,0,0,0.14);
      border-radius: 12px;
      margin: 8px 0;
      cursor: pointer;
      background: rgba(255,255,255,0.85);
    }
    .options input { margin-right: 8px; }

    progress { width: 100%; height: 16px; border-radius: 999px; overflow: hidden; }

    .footerNote {
      color: rgba(255,255,255,0.80);
      font-size: 0.92rem;
      margin-top: 8px;
    }

    .topTitle {
      padding: 10px 0 2px;
    }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="overlay"></div>

  <div class="container">
    <div class="topTitle">
      <h1>QCM Culture Incendie (diagnostic)</h1>
      <p class="muted">
        30 questions ‚Ä¢ <strong>30 secondes par question</strong> ‚Ä¢ objectif : √©tat des lieux de connaissances (formation EPI suppos√©e).
      </p>
      <p class="footerNote">
        Donn√©es : service obligatoire. Nom/pr√©nom facultatifs. Pas de mail, pas de matricule.
      </p>
    </div>

    <!-- INTRO -->
    <div id="startCard" class="card">
      <p><strong>Consigne :</strong> r√©ponds spontan√©ment. Si le temps expire, on passe automatiquement √† la question suivante.</p>

      <div class="card" style="background: rgba(255,255,255,0.86); box-shadow:none;">
        <h3 style="margin-top:0;">Informations (minimales)</h3>

        <label for="serviceOrigin"><strong>Service d‚Äôorigine (obligatoire)</strong></label><br />
        <select id="serviceOrigin">
          <option value="">‚Äî S√©lectionner ‚Äî</option>
          <option value="Escale">Escale</option>
          <option value="Vente / Accueil">Vente / Accueil</option>
          <option value="ASCT">ASCT</option>
          <option value="Conducteur">Conducteur</option>
          <option value="S√ªret√©">S√ªret√©</option>
          <option value="Maintenance / Technique">Maintenance / Technique</option>
          <option value="Gares & Connexions">Gares & Connexions</option>
          <option value="Autre">Autre</option>
        </select>

        <div id="otherServiceWrap" style="display:none; margin-top:10px;">
          <label for="serviceOther">Pr√©ciser ‚ÄúAutre‚Äù (obligatoire si Autre)</label>
          <input id="serviceOther" type="text" placeholder="Ex : Logistique, Propret√©, etc." />
        </div>

        <div class="row" style="margin-top:12px;">
          <div style="flex:1; min-width:220px;">
            <label for="lastName">Nom (facultatif)</label><br />
            <input id="lastName" type="text" placeholder="Nom" />
          </div>
          <div style="flex:1; min-width:220px;">
            <label for="firstName">Pr√©nom (facultatif)</label><br />
            <input id="firstName" type="text" placeholder="Pr√©nom" />
          </div>
        </div>

        <p style="margin:10px 0 0; color:#222;">
          <strong>Anonymat :</strong> tes r√©ponses sont exploit√©es statistiquement.
          Nom/pr√©nom ne servent qu‚Äô√† un √©ventuel retour individuel, si tu choisis de les renseigner.
        </p>
      </div>

      <button id="startBtn" style="margin-top:12px;">D√©marrer</button>
      <p id="startWarn" class="danger" style="display:none; margin-top:10px;">
        Merci de s√©lectionner ton service d‚Äôorigine (et pr√©ciser ‚ÄúAutre‚Äù si besoin) avant de d√©marrer.
      </p>
    </div>

    <!-- QUIZ -->
    <div id="quizCard" class="card" style="display:none;">
      <div class="row">
        <div class="pill">Question <span id="qIndex">1</span>/<span id="qTotal">30</span></div>
        <div class="pill">Temps restant : <span id="timeLeft">30</span>s</div>
      </div>

      <progress id="progress" value="0" max="30"></progress>

      <h2 id="questionText" style="margin-top:14px;"></h2>
      <div id="options" class="options"></div>

      <div class="row" style="margin-top:12px;">
        <button id="nextBtn" disabled>Valider & suivant</button>
        <button id="skipBtn" class="secondary">Passer</button>
        <span id="warn" class="danger" style="display:none;">S√©lectionne une r√©ponse (ou ‚ÄúPasser‚Äù).</span>
      </div>
    </div>

    <!-- FINAL -->
    <div id="finalCard" class="card" style="display:none;">
      <h2>Derni√®re √©tape : expression libre</h2>
      <p style="color:#222; margin-top:6px;">
        Tu peux signaler ce qui t‚Äôa manqu√©, ce qui t‚Äôa surpris, une difficult√©, ou une situation v√©cue.
      </p>
      <textarea id="freeText" placeholder="Ton retour (optionnel)"></textarea>

      <div class="row" style="margin-top:12px;">
        <button id="sendBtn">Envoyer</button>
        <button id="restartBtn" class="secondary">Recommencer</button>
        <span id="sendStatus" style="color:#222;"></span>
      </div>
      <p id="sendErr" class="danger" style="display:none; margin-top:10px;"></p>
    </div>

    <!-- DONE -->
    <div id="doneCard" class="card" style="display:none;">
      <h2>Merci üëç</h2>
      <p style="color:#222;">Tes r√©ponses ont √©t√© envoy√©es.</p>
    </div>
  </div>

<script>
/**
 * 1) Mets ici TON URL Apps Script (application web)
 * Exemple : https://script.google.com/macros/s/XXXX/exec
 */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxUEd5XAQMwUuYegD1lvoyXaqimuysXqP3YVKeUe2HcqRUWYc5vO0g92xrMG8GPQNudiQ/exec";

/**
 * 2) Mets ici tes 30 questions.
 * - id unique
 * - text
 * - options
 * - correctIndex (si tu veux calculer un score; sinon mets null)
 *
 * NOTE : Ici je mets 3 exemples. Tu compl√®tes jusqu‚Äô√† 30.
 */
const QUESTIONS = [
  {
    id: "Q1",
    text: "Qu‚Äôest-ce qui d√©finit un incendie (culture incendie) ?",
    options: [
      "Un feu visible produisant des flammes",
      "Une combustion non ma√Ætris√©e dans le temps et l‚Äôespace",
      "Toute √©mission de fum√©e dans un local",
      "Une √©l√©vation anormale de temp√©rature"
    ],
    correctIndex: 1
  },
  {
    id: "Q2",
    text: "Le t√©tra√®dre du feu ajoute un √©l√©ment au triangle classique. Lequel ?",
    options: ["La pression", "Les radicaux libres", "L‚Äô√©lectricit√©", "Le carburant"],
    correctIndex: 1
  },
  {
    id: "Q3",
    text: "Pourquoi les fum√©es sont-elles souvent plus dangereuses que les flammes ?",
    options: [
      "Elles sont invisibles",
      "Elles contiennent principalement du CO‚ÇÇ",
      "Elles sont toxiques, chaudes et appauvrissent l‚Äôair en oxyg√®ne",
      "Elles d√©clenchent les d√©tecteurs"
    ],
    correctIndex: 2
  },
  // ... ajoute jusqu‚Äô√† 30
];

const SECONDS_PER_QUESTION = 30;

const $ = (id) => document.getElementById(id);

$("qTotal").textContent = QUESTIONS.length;

let idx = 0;
let timer = null;
let timeLeft = SECONDS_PER_QUESTION;
let answers = []; // {id, selectedIndex|null, isCorrect|null, timedOut:boolean}
let startedAtISO = null;

// Infos r√©pondant
let respondent = {
  serviceOrigin: "",
  serviceOther: "",
  lastName: "",
  firstName: ""
};

function show(elId) { $(elId).style.display = "block"; }
function hide(elId) { $(elId).style.display = "none"; }

function normalizeService() {
  const service = $("serviceOrigin").value;
  const other = ($("serviceOther").value || "").trim();
  if (service === "Autre") return other ? `Autre - ${other}` : "Autre";
  return service;
}

$("serviceOrigin").addEventListener("change", () => {
  const v = $("serviceOrigin").value;
  if (v === "Autre") show("otherServiceWrap");
  else hide("otherServiceWrap");
});

function resetTimer() {
  clearInterval(timer);
  timeLeft = SECONDS_PER_QUESTION;
  $("timeLeft").textContent = timeLeft;
  $("progress").value = 0;
  $("progress").max = SECONDS_PER_QUESTION;

  timer = setInterval(() => {
    timeLeft--;
    $("timeLeft").textContent = timeLeft;
    $("progress").value = SECONDS_PER_QUESTION - timeLeft;

    if (timeLeft <= 0) {
      clearInterval(timer);
      // Auto-pass : on enregistre r√©ponse vide si rien n‚Äôest coch√©
      commitAnswer(true);
      nextQuestion();
    }
  }, 1000);
}

function renderQuestion() {
  const q = QUESTIONS[idx];
  $("qIndex").textContent = idx + 1;
  $("questionText").textContent = q.text;

  const optionsDiv = $("options");
  optionsDiv.innerHTML = "";

  q.options.forEach((opt, i) => {
    const label = document.createElement("label");
    label.innerHTML = `<input type="radio" name="opt" value="${i}"> ${opt}`;
    optionsDiv.appendChild(label);
  });

  $("nextBtn").disabled = true;
  hide("warn");

  optionsDiv.addEventListener("change", () => {
    $("nextBtn").disabled = false;
    hide("warn");
  }, { once: true });

  resetTimer();
}

function getSelectedIndex() {
  const el = document.querySelector('input[name="opt"]:checked');
  return el ? Number(el.value) : null;
}

function commitAnswer(timedOut = false) {
  const q = QUESTIONS[idx];
  const selected = getSelectedIndex();

  let isCorrect = null;
  if (q.correctIndex === null || q.correctIndex === undefined) {
    isCorrect = null;
  } else if (selected === null) {
    isCorrect = null;
  } else {
    isCorrect = (selected === q.correctIndex);
  }

  answers.push({
    id: q.id,
    selectedIndex: selected,
    isCorrect,
    timedOut
  });
}

function nextQuestion() {
  idx++;
  if (idx >= QUESTIONS.length) {
    clearInterval(timer);
    hide("quizCard");
    show("finalCard");
    return;
  }
  renderQuestion();
}

$("startBtn").addEventListener("click", () => {
  const service = $("serviceOrigin").value;
  const other = ($("serviceOther").value || "").trim();

  if (!service) {
    show("startWarn");
    return;
  }
  if (service === "Autre" && !other) {
    show("startWarn");
    return;
  }
  hide("startWarn");

  respondent.serviceOrigin = normalizeService();
  respondent.lastName = ($("lastName").value || "").trim();
  respondent.firstName = ($("firstName").value || "").trim();

  startedAtISO = new Date().toISOString();

  hide("startCard");
  show("quizCard");
  idx = 0;
  answers = [];
  renderQuestion();
});

$("nextBtn").addEventListener("click", () => {
  clearInterval(timer);
  const sel = getSelectedIndex();
  if (sel === null) {
    show("warn");
    return;
  }
  commitAnswer(false);
  nextQuestion();
});

$("skipBtn").addEventListener("click", () => {
  clearInterval(timer);
  commitAnswer(false);
  nextQuestion();
});

$("restartBtn").addEventListener("click", () => {
  // Reset soft
  hide("finalCard");
  show("startCard");
  $("freeText").value = "";
  $("sendStatus").textContent = "";
  hide("sendErr");
  $("sendBtn").disabled = false;
});

$("sendBtn").addEventListener("click", async () => {
  hide("sendErr");
  $("sendBtn").disabled = true;
  $("sendStatus").textContent = "Envoi en cours‚Ä¶";

  // Calculs
  const answeredCount = answers.filter(a => a.selectedIndex !== null).length;
  const correctCount = answers.filter(a => a.isCorrect === true).length;

  const payload = {
    submittedAtISO: new Date().toISOString(),
    startedAtISO,
    durationSeconds: startedAtISO ? Math.round((Date.now() - Date.parse(startedAtISO)) / 1000) : "",

    serviceOrigin: respondent.serviceOrigin, // obligatoire (d√©j√† valid√©)
    lastName: respondent.lastName,           // facultatif
    firstName: respondent.firstName,         // facultatif

    totalQuestions: QUESTIONS.length,
    answeredCount,
    correctCount,

    answers, // d√©tails
    freeText: ($("freeText").value || "").trim(),

    // trace l√©g√®re (pas d‚Äôidentifiant technique)
    clientInfo: {
      userAgent: navigator.userAgent || ""
    }
  };

  if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes("COLLE_ICI")) {
    $("sendStatus").textContent = "";
    $("sendBtn").disabled = false;
    $("sendErr").textContent = "APPS_SCRIPT_URL non configur√©e. Colle l‚ÄôURL de ton Apps Script dans le code.";
    show("sendErr");
    return;
  }

  try {
    const res = await fetch(APPS_SCRIPT_URL, {
  method: "POST",
  body: JSON.stringify(payload) // IMPORTANT : pas de headers
});

    });

    const txt = await res.text();
    // Certaines configs Apps Script renvoient du texte JSON
    let ok = false;
    try {
      const j = JSON.parse(txt);
      ok = !!j.ok;
      if (!ok) throw new Error(j.error || "Erreur inconnue");
    } catch (_) {
      // si ce n'est pas du JSON, on consid√®re OK si HTTP 200-299
      ok = res.ok;
    }

    if (!ok) throw new Error("Envoi refus√© par le serveur.");

    $("sendStatus").textContent = "Envoy√© ‚úÖ";
    hide("finalCard");
    show("doneCard");

  } catch (err) {
    $("sendStatus").textContent = "";
    $("sendBtn").disabled = false;
    $("sendErr").textContent = "√âchec de l‚Äôenvoi : " + (err && err.message ? err.message : String(err));
    show("sendErr");
  }
});
</script>
</body>
</html>
