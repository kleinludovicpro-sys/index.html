<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QCM Culture Incendie - Diagnostic</title>
  <style>
    :root { --card-bg: rgba(255,255,255,0.94); --border: rgba(255,255,255,0.35); }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; min-height: 100vh; color: #111; background: #0f1115; }
    .bg { position: fixed; inset: 0; background-image: url("regiolis.jpg"); background-size: cover; background-position: center; z-index: -3; pointer-events: none; }
    .overlay { position: fixed; inset: 0; background: linear-gradient(180deg, rgba(0,0,0,0.72), rgba(0,0,0,0.55)); z-index: -2; pointer-events: none; }
    .container { max-width: 980px; margin: 0 auto; padding: 22px 14px 40px; position: relative; z-index: 1; }
    h1, h2, h3 { margin: 0 0 10px; color: #fff; }
    p { margin: 8px 0; }
    .muted { color: rgba(255,255,255,0.86); font-size: 0.98rem; line-height: 1.35; }
    .danger { color: #ffb4b4; font-weight: 750; }
    .ok { color: #0a7a3f; font-weight: 750; }
    .card { border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin: 14px 0; background: var(--card-bg); backdrop-filter: blur(6px); box-shadow: 0 12px 30px rgba(0,0,0,0.25); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .pill { background: rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.08); border-radius: 999px; padding: 6px 10px; font-weight: 750; }
    button { padding: 11px 14px; border-radius: 12px; border: 1px solid #111; background: #111; color: #fff; cursor: pointer; font-weight: 750; }
    button.secondary { background: #fff; color: #111; border: 1px solid rgba(0,0,0,0.25); }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    label { font-weight: 750; }
    input[type="text"], select, textarea { width: 100%; padding: 10px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.20); font-size: 1rem; background: #fff; }
    textarea { min-height: 120px; resize: vertical; }
    .options label { display: block; padding: 10px 10px; border: 1px solid rgba(0,0,0,0.14); border-radius: 12px; margin: 8px 0; cursor: pointer; background: rgba(255,255,255,0.92); }
    .options input { margin-right: 8px; }
    progress { width: 100%; height: 16px; border-radius: 999px; overflow: hidden; }
    #quizCard { background: rgba(255,255,255,0.96) !important; }
    #questionText { color: #111 !important; font-size: 1.3rem; font-weight: 800; line-height: 1.35; }
  </style>
</head>
<body>
  <div class="bg"></div>
  <div class="overlay"></div>
  <div class="container">
    <h1>QCM Culture Incendie (diagnostic)</h1>
    <p class="muted">30 questions ‚Ä¢ 30s / question ‚Ä¢ Culture EPI attendue.</p>
    
    <div id="startCard" class="card">
      <h3 style="color:#111">Informations minimales</h3>
      <label for="serviceOrigin">Service d‚Äôorigine (obligatoire)</label>
      <select id="serviceOrigin">
        <option value="">‚Äî S√©lectionner ‚Äî</option>
        <option value="Escale">Escale</option>
        <option value="Vente / Accueil">Vente / Accueil</option>
        <option value="ASCT">ASCT</option>
        <option value="Conducteur">Conducteur</option>
        <option value="S√ªret√©">S√ªret√©</option>
        <option value="Maintenance / Technique">Maintenance / Technique</option>
        <option value="Gares & Connexions">Gares & Connexions</option>
        <option value="Autre">Autre</option>
      </select>
      <div id="otherServiceWrap" style="display:none; margin-top:10px;">
        <input id="serviceOther" type="text" placeholder="Pr√©cisez votre service" />
      </div>
      <div class="row" style="margin-top:12px;">
        <input id="lastName" type="text" placeholder="Nom (facultatif)" style="flex:1" />
        <input id="firstName" type="text" placeholder="Pr√©nom (facultatif)" style="flex:1" />
      </div>
      <button id="startBtn" style="margin-top:15px;" disabled>D√©marrer</button>
      <p id="startWarn" class="danger" style="display:none;">Merci de s√©lectionner ton service.</p>
    </div>

    <div id="quizCard" class="card" style="display:none;">
      <div class="row">
        <div class="pill">Q <span id="qIndex">1</span>/<span id="qTotal">30</span></div>
        <div class="pill">Temps : <span id="timeLeft">30</span>s</div>
      </div>
      <progress id="progress" value="0" max="30"></progress>
      <h2 id="questionText"></h2>
      <div id="options" class="options"></div>
      <div class="row">
        <button id="nextBtn" disabled>Valider & suivant</button>
        <button id="skipBtn" class="secondary">Passer</button>
      </div>
    </div>

    <div id="finalCard" class="card" style="display:none;">
      <h2>Expression libre (optionnel)</h2>
      <textarea id="freeText" placeholder="Tes retours..."></textarea>
      <div class="row" style="margin-top:12px;">
        <button id="sendBtn">Envoyer</button>
        <span id="sendStatus"></span>
      </div>
      <p id="sendErr" class="danger" style="display:none;"></p>
    </div>

    <div id="doneCard" class="card" style="display:none;">
      <h2 style="color:#111">Merci üëç</h2>
      <p class="ok">Tes r√©ponses ont √©t√© envoy√©es. Tu peux fermer cette page.</p>
    </div>
  </div>

<script>
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx0kqt1t0nhy3DVU6iJ4vQT4vDLfv_Gz7Jdoha3Ydx-FZdK8KAhdmQa73A3_VTMPt6xKA/exec";
  const SECONDS_PER_QUESTION = 30;

  const QUESTIONS = [
    { id:"Q1", text:"Qu‚Äôest-ce qui d√©finit un incendie ?", options:["Un feu visible","Une combustion non ma√Ætris√©e","Toute √©mission de fum√©e","Hausse de temp√©rature"], correctIndex:1 },
    { id:"Q2", text:"√âl√©ment ajout√© au triangle du feu pour le t√©tra√®dre :", options:["Pression","Radicaux libres","√âlectricit√©","Carburant"], correctIndex:1 },
    { id:"Q3", text:"Supprimer un √©l√©ment du t√©tra√®dre entra√Æne :", options:["Ralentissement","Extinction","Explosion","Baisse de fum√©es"], correctIndex:1 },
    { id:"Q4", text:"Mont√©e des fum√©es chaudes au plafond :", options:["Conduction","Rayonnement","Convection","Diffusion"], correctIndex:2 },
    { id:"Q5", text:"Danger principal des fum√©es :", options:["Invisibles","Surtout CO2","Toxiques, chaudes et sans O2","SSI"], correctIndex:2 },
    { id:"Q6", text:"Le CO est dangereux car :", options:["Visible","Incolore/inodore et mortel","Explose vite","Sans effet debout"], correctIndex:1 },
    { id:"Q7", text:"Un feu ma√Ætrisable EPI est :", options:["G√©n√©ralis√©","Naissant, sans propagation","√âpais","Derri√®re porte chaude"], correctIndex:1 },
    { id:"Q8", text:"Priorit√© absolue en gare :", options:["√âteindre","S√©curit√© des personnes","Sauver mat√©riel","Limiter retards"], correctIndex:1 },
    { id:"Q9", text:"√âtousser un feu c'est :", options:["Refroidir","Supprimer combustible","Couper l'oxyg√®ne","Courant d'air"], correctIndex:2 },
    { id:"Q10", text:"Phase auto-entretenue :", options:["Inflammation","Combustion entretenue","Refroidissement","Condensation"], correctIndex:1 },
    { id:"Q11", text:"R√®gle face aux fum√©es (non √©quip√©) :", options:["Identifier foyer","Approcher","Ne pas s'exposer, alerter","Ventiler"], correctIndex:2 },
    { id:"Q12", text:"Ouvrir brutalement une porte en feu :", options:["√âteint le feu","Appel d'air / aggravation","Coupe √©lectricit√©","D√©sactive d√©tecteurs"], correctIndex:1 },
    { id:"Q13", text:"La lev√©e de doute sert √† :", options:["√âteindre","Confirmer le sinistre","R√©armer SSI","√âvacuer tout"], correctIndex:1 },
    { id:"Q14", text:"Principe en lev√©e de doute :", options:["Sortir victimes","Extincteur pr√©ventif","Ne jamais s'exposer au danger","Attendre"], correctIndex:2 },
    { id:"Q15", text:"Qui r√©arme le SSI apr√®s fausse alarme ?", options:["Le CEV","Tout le monde","Mainteneur seulement","Public"], correctIndex:0 },
    { id:"Q16", text:"D√©part feu non ma√Ætrisable confirm√© :", options:["Continuer seul","Alerte + s√©curit√© + accueil","R√©armer","Prendre ascenseur"], correctIndex:1 },
    { id:"Q17", text:"Alerte imm√©diate 18/112 si :", options:["Simple doute","Odeur l√©g√®re","Fum√©es/feu/propagation","DM d√©clench√©"], correctIndex:2 },
    { id:"Q18", text:"Info utile aux secours :", options:["Cause probable","Lieu + √âtendue/propagation","Nom chef de gare","Retards trains"], correctIndex:1 },
    { id:"Q19", text:"R√¥le du CEV pour les pompiers :", options:["Diriger","Interlocuteur site / infos","Exploitation","Intervenir"], correctIndex:1 },
    { id:"Q20", text:"Suspicion de gaz :", options:["Lumi√®res","T√©l√©phone zone","Mise en s√©curit√©, alerter","Chercher fuite"], correctIndex:2 },
    { id:"Q21", text:"Risque √©lectrique BV :", options:["Toucher armoires","Coupure imm√©diate","√âviter zone / pr√©venir","Eau"], correctIndex:2 },
    { id:"Q22", text:"Extincteur eau pulv√©ris√©e :", options:["Solides (A)","M√©taux","Gaz","Tout"], correctIndex:0 },
    { id:"Q23", text:"Extincteur CO2 :", options:["Classe A","√âlectrique / liquides","Gaz","M√©taux"], correctIndex:1 },
    { id:"Q24", text:"Extincteur poudre :", options:["Refroidir","Couper r√©action chimique","Fum√©es","Projections"], correctIndex:1 },
    { id:"Q25", text:"Danger majeur local ferm√© :", options:["Distance","Tester porte","Ouvrir grand pour voir","Alerter"], correctIndex:2 },
    { id:"Q26", text:"Point de rassemblement :", options:["Pause","Recenser / centraliser","Observer","Attendre"], correctIndex:1 },
    { id:"Q27", text:"Guide/serre-file :", options:["√âteindre","Organiser √©vacuation","Remplacer pompiers","Billets"], correctIndex:1 },
    { id:"Q28", text:"Priorit√© victime :", options:["Cause","S√©curit√© + Alerte + Gestes","Exploitation","Photos"], correctIndex:1 },
    { id:"Q29", text:"Fin de sinistre rel√®ve de :", options:["Public","Pompier (oral)","Responsabilit√© SNCF","Appelant"], correctIndex:2 },
    { id:"Q30", text:"But du QCM :", options:["Sanctionner","Habiliter","Mesurer niveau initial","Remplacer pratique"], correctIndex:2 }
  ];

  const $ = (id) => document.getElementById(id);
  $("qTotal").textContent = QUESTIONS.length;

  let idx = 0, timer = null, timeLeft = SECONDS_PER_QUESTION, answers = [], startedAtISO = null;
  const resp = { service:"", last:"", first:"" };

  function show(id) { $(id).style.display = "block"; }
  function hide(id) { $(id).style.display = "none"; }
  function text(id, t) { $(id).textContent = t; }

  function refreshStart() {
    const s = $("serviceOrigin").value;
    const o = ($("serviceOther").value || "").trim();
    $("startBtn").disabled = !s || (s === "Autre" && !o);
  }

  $("serviceOrigin").onchange = () => {
    $("otherServiceWrap").style.display = ($("serviceOrigin").value === "Autre") ? "block" : "none";
    refreshStart();
  };
  $("serviceOther").oninput = refreshStart;

  function resetTimer() {
    clearInterval(timer);
    timeLeft = SECONDS_PER_QUESTION;
    text("timeLeft", timeLeft);
    $("progress").value = 0;
    timer = setInterval(() => {
      timeLeft--;
      text("timeLeft", timeLeft);
      $("progress").value = SECONDS_PER_QUESTION - timeLeft;
      if (timeLeft <= 0) { commit(true); next(); }
    }, 1000);
  }

  function render() {
    const q = QUESTIONS[idx];
    text("qIndex", idx + 1);
    text("questionText", q.text);
    $("options").innerHTML = "";
    q.options.forEach((o, i) => {
      const l = document.createElement("label");
      l.innerHTML = `<input type="radio" name="opt" value="${i}"> ${o}`;
      $("options").appendChild(l);
    });
    $("nextBtn").disabled = true;
    $("options").onclick = () => $("nextBtn").disabled = false;
    resetTimer();
  }

  function commit(t=false) {
    const q = QUESTIONS[idx];
    const sel = document.querySelector('input[name="opt"]:checked');
    const val = sel ? parseInt(sel.value) : null;
    answers.push({ id:q.id, selected:val, isCorrect: val === q.correctIndex, timedOut:t });
  }

  function next() {
    idx++;
    if (idx >= QUESTIONS.length) { clearInterval(timer); hide("quizCard"); show("finalCard"); }
    else render();
  }

  $("startBtn").onclick = () => {
    resp.service = ($("serviceOrigin").value === "Autre") ? $("serviceOther").value : $("serviceOrigin").value;
    resp.last = $("lastName").value;
    resp.first = $("firstName").value;
    startedAtISO = new Date().toISOString();
    hide("startCard"); show("quizCard"); render();
  };

  $("nextBtn").onclick = () => { commit(); next(); };
  $("skipBtn").onclick = () => { commit(); next(); };

  $("sendBtn").onclick = async () => {
    $("sendBtn").disabled = true;
    text("sendStatus", "Envoi...");
    const payload = {
      submittedAtISO: new Date().toISOString(),
      startedAtISO,
      durationSeconds: Math.round((Date.now() - Date.parse(startedAtISO))/1000),
      serviceOrigin: resp.service,
      lastName: resp.last,
      firstName: resp.first,
      totalQuestions: QUESTIONS.length,
      answeredCount: answers.filter(a => a.selected !== null).length,
      correctCount: answers.filter(a => a.isCorrect).length,
      answers,
      freeText: $("freeText").value
    };

    try {
      await fetch(APPS_SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
      hide("finalCard"); show("doneCard");
    } catch (e) {
      $("sendBtn").disabled = false;
      text("sendErr", "Erreur: " + e); show("sendErr");
    }
  };
</script>
</body>
</html>
