<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QCM Culture Incendie - Diagnostic</title>

  <style>
    :root { 
      --card-bg: rgba(255,255,255,0.72); 
      --accent: #111;
      --sncf-blue: #0088ce;
      --border: rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0; min-height: 100vh; color: #111; background: #0f1115;
    }
    .bg {
      position: fixed; inset: 0;
      background-image: url("regiolis.jpg");
      background-size: cover; background-position: center;
      z-index: -3; pointer-events: none;
    }
    .overlay {
      position: fixed; inset: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0.7), rgba(0,0,0,0.5));
      z-index: -2; pointer-events: none;
    }
    .container { max-width: 800px; margin: 0 auto; padding: 20px 15px; position: relative; z-index: 1; }
    h1 { color: #fff; font-size: 1.6rem; text-align: center; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .muted { color: rgba(255,255,255,0.9); text-align: center; font-size: 0.9rem; margin-bottom: 20px; }
    .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    label { font-weight: 700; display: block; margin-bottom: 5px; margin-top: 10px; }
    input[type="text"], select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 1rem; margin-bottom: 10px; }
    button { width: 100%; padding: 14px; border-radius: 10px; border: none; background: var(--accent); color: #fff; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 10px; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    button.secondary { background: #fff; color: #111; border: 1px solid #ccc; }
    .pill { background: #eee; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; }
    progress { width: 100%; height: 10px; margin: 15px 0; border-radius: 5px; }
    #questionText { font-size: 1.25rem; font-weight: 800; line-height: 1.3; margin: 15px 0; }
    .options label { display: flex; align-items: center; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: background 0.2s; }
    .options label:hover { background: #f9f9f9; }
    .options input { transform: scale(1.3); margin-right: 12px; }
    .danger { color: #d32f2f; font-weight: 700; }
    .ok { color: #2e7d32; font-weight: 700; text-align: center; }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="overlay"></div>

  <div class="container">
    <h1>QCM Culture Incendie</h1>
    <p class="muted"><span id="totalQTop">30</span> questions â€¢ 15 secondes par question</p>

    <div id="startCard" class="card">
      <label>Service dâ€™origine (obligatoire)</label>
      <select id="serviceOrigin">
        <option value="">â€” SÃ©lectionner â€”</option>
        <option value="Escale">Escale</option>
        <option value="Vente / Accueil">Vente / Accueil</option>
        <option value="ASCT">ASCT</option>
        <option value="Conducteur">Conducteur</option>
        <option value="SÃ»retÃ©">SÃ»retÃ©</option>
        <option value="Maintenance / Technique">Maintenance / Technique</option>
        <option value="Gares & Connexions">Gares & Connexions</option>
        <option value="Autre">Autre</option>
      </select>

      <div id="otherServiceWrap" style="display:none;">
        <input id="serviceOther" type="text" placeholder="PrÃ©cisez votre service" />
      </div>

      <label>Nom (obligatoire)</label>
      <input id="lastName" type="text" placeholder="Nom" />

      <label>PrÃ©nom (obligatoire)</label>
      <input id="firstName" type="text" placeholder="PrÃ©nom" />

      <button id="startBtn">DÃ©marrer le diagnostic</button>
      <p id="startWarn" class="danger" style="display:none; text-align:center;">
        Service + Nom + PrÃ©nom obligatoires.
      </p>
    </div>

    <div id="quizCard" class="card" style="display:none;">
      <div style="display:flex; justify-content: space-between;">
        <span class="pill">Q <span id="qIndex">1</span>/<span id="totalQ">30</span></span>
        <span class="pill">Chrono: <span id="timeLeft">15</span>s</span>
      </div>
      <progress id="progress" value="0" max="15"></progress>
      <div id="questionText">...</div>
      <div id="options" class="options"></div>
      <button id="nextBtn" disabled>Valider & Suivant</button>
      <button id="skipBtn" class="secondary">Passer</button>
    </div>

    <div id="finalCard" class="card" style="display:none;">
      <h2 style="margin-top:0;">Diagnostic terminÃ©</h2>
      <label>Un retour Ã  nous faire ? (optionnel)</label>
      <textarea id="freeText" placeholder="DifficultÃ©s rencontrÃ©es, points flous..."></textarea>
      <button id="sendBtn">Envoyer mes rÃ©sultats</button>
      <p id="sendStatus" style="text-align:center; font-weight:bold;"></p>
    </div>

    <div id="doneCard" class="card" style="display:none;">
      <h2 class="ok">âœ… RÃ©sultats envoyÃ©s</h2>
      <p style="text-align:center;">Merci pour votre participation.</p>
    </div>
  </div>

<script>
  // CONFIGURATION
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx0kqt1t0nhy3DVU6iJ4vQT4vDLfv_Gz7Jdoha3Ydx-FZdK8KAhdmQa73A3_VTMPt6xKA/exec";
  const TIME_LIMIT = 15;

  // QUESTIONS (30 annoncÃ©es, mais ici la liste est la source de vÃ©ritÃ©)
  const QUESTIONS = [
    { id:"Q1", text:"Quâ€™est-ce qui dÃ©finit un incendie ?", options:["Un feu visible","Une combustion non maÃ®trisÃ©e","Toute Ã©mission de fumÃ©e","Hausse de tempÃ©rature"], correctIndex:1 },
    { id:"Q2", text:"Ã‰lÃ©ment ajoutÃ© au triangle du feu pour le tÃ©traÃ¨dre :", options:["Pression","Radicaux libres","Ã‰lectricitÃ©","Carburant"], correctIndex:1 },
    { id:"Q3", text:"Supprimer un Ã©lÃ©ment au triangle du feu entraÃ®ne :", options:["Ralentissement","Extinction","Explosion","Baisse de fumÃ©es"], correctIndex:1 },
    { id:"Q4", text:"Le mode de propagation d'un incendie par montÃ©e des fumÃ©es chaudes au plafond se nomme :", options:["Conduction","Rayonnement","Convection","Diffusion"], correctIndex:2 },
    { id:"Q5", text:"Danger principal des fumÃ©es :", options:["Invisibles","Surtout CO2","Toxiques, chaudes et sans O2","SSI"], correctIndex:2 },
    { id:"Q6", text:"Le monoxyde de carbonne est dangereux car :", options:["Visible","Incolore/inodore et mortel","Explose vite","Sans effet debout"], correctIndex:1 },
    { id:"Q7", text:"Un feu maÃ®trisable pour un agent formÃ© Equipier de PremiÃ©re Intervention (CEV par exemple) est :", options:["GÃ©nÃ©ralisÃ©","Naissant, sans propagation","Ã‰pais","DerriÃ¨re porte chaude"], correctIndex:1 },
    { id:"Q8", text:"En gare de Bayonne, la coupure totale dâ€™Ã©lectricitÃ© est :", options:["ImmÃ©diate et simple","Impossible en cas dâ€™incendie","Complexe et non immÃ©diate","Automatique dÃ¨s lâ€™alarme"], correctIndex:2 },
    { id:"Q9", text:"Ã‰touffer un feu c'est :", options:["Refroidir","Supprimer le combustible","Couper l'oxygÃ¨ne","Courant d'air"], correctIndex:2 },
    { id:"Q10", text:"Quel signe indique quâ€™il ne faut pas ouvrir une porte (risque de phÃ©nomÃ¨ne thermique) ?:", options:["La poignÃ©e est froide","Pas de fumÃ©e visible","Porte/poignÃ©e chaude et/ou fumÃ©es","Le SSI est en dÃ©faut"], correctIndex:2 },
    { id:"Q11", text:"RÃ¨gle face aux fumÃ©es (non Ã©quipÃ©) :", options:["Identifier foyer","Approcher","Ne pas s'exposer, alerter","Ventiler"], correctIndex:2 },
    { id:"Q12", text:"Ouvrir brutalement une porte en feu :", options:["Ã‰teint le feu","GÃ©nÃ©re un appel d'air","Peut suffire Ã  souffler le feu","Risque de dÃ©sactiver les dÃ©tecteurs"], correctIndex:1 },
    { id:"Q13", text:"La levÃ©e de doute signifie :", options:["Confirmer ou infirmer le fonctionnement du SSI","Confirmer/infirmer un incendie","Confirmer/infirmer le rÃ©armement SSI","Confirmer/infirmer l'Ã©vacuation totale"], correctIndex:1 },
    { id:"Q14", text:"Principe en levÃ©e de doute :", options:["Chercher les victimes","Aviser l'ensemble du personnel d'un danger","Ne jamais s'exposer au danger","Aerer au maximum les locaux pour chasser les fumÃ©es"], correctIndex:2 },
    { id:"Q15", text:"Qui rÃ©arme le SSI aprÃ¨s fausse alarme ?", options:["Le CEV","Tout le monde","Mainteneur seulement","l'astreinte SOL"], correctIndex:0 },
    { id:"Q16", text:"Lors d'un feu non maÃ®trisable je :", options:["Alerte les secours + aide Ã  l'evacuation + me rend auy point de rassemblement","Alerte le COGC + alerte les secours + lutte contre l'incendie","RÃ©arme le SSI","Prendre ascenseur"], correctIndex:0 },
    { id:"Q17", text:"Alerte immÃ©diate 18/112 si :", options:["Simple doute","Odeur lÃ©gÃ¨re de brulÃ©","FumÃ©es/feu/propagation","DM dÃ©clenchÃ©"], correctIndex:2 },
    { id:"Q18", text:"Info utile aux secours :", options:["Cause probable","Lieu + Ã‰tendue/propagation","Nom chef de gare","Retards trains"], correctIndex:1 },
    { id:"Q19", text:"RÃ´le du CEV pour les pompiers :", options:["Diriger les opÃ©rations de sauvetages et d'extinctions","Interlocuteur du site","S'assure du respect de la SEF par les secours","accompagner les secours au local sinistrÃ©"], correctIndex:1 },
    { id:"Q20", text:"En cas de suspicion fuite de gaz ma premiÃ©re action est  :", options:["J'eteins les lumiÃ¨res et j'alerte","je coupe mon tÃ©lÃ©phone et j'alerte","Je manoeuvre les coupures d'urgences et j'alerte","Je cherche la fuite avec l'aide de l'AET si necessaire"], correctIndex:2 },
    { id:"Q21", text:"La levÃ©e de doute doit Ãªtre rÃ©alisÃ©e :", options:["MÃªme en situation dangereuse","Sans se mettre en danger","Sans prÃ©venir personne","Uniquement par les pompiers"], correctIndex:1 },
    { id:"Q22", text:"Un extincteur eau pulvÃ©risÃ©e est privilegiÃ© pour la classe :", options:["Solides (A)","MÃ©taux (D)","Gaz (C)","huiles et graisses de cuisson (F)"], correctIndex:0 },
    { id:"Q23", text:"Un extincteur CO2 est privilegiÃ© pour les feux d'origine :", options:["Solides","Ã‰lectrique / liquides","Gaz","Sans flamme"], correctIndex:1 },
    { id:"Q24", text:"Quel est le moyen d'extinction d'un extincteur Ã  poudre :", options:["Refroidir","Couper rÃ©action chimique","FumÃ©es","Projections"], correctIndex:1 },
    { id:"Q26", text:"ResponsabilitÃ© pÃ©nale du chef dâ€™escale engagÃ©e si :", options:["Incendie dÃ©clarÃ©","Secours en retard","Faute ou nÃ©gligence","Plainte dâ€™un voyageur"], correctIndex:2 },
    { id:"Q27", text:"Point de rassemblement :", options:["Pause","Recenser / centraliser","Observer","Attendre"], correctIndex:1 },
    { id:"Q28", text:"Guide/serre-file :", options:["Ã‰teindre","Organiser Ã©vacuation","Remplacer pompiers","Billets"], correctIndex:1 },
    { id:"Q29", text:"PrioritÃ© victime :", options:["Cause","SÃ©curitÃ© + Alerte + Gestes","Exploitation","Photos"], correctIndex:1 },
    { id:"Q30", text:"La reprise d'exploitation suite Ã  un important sinistre en gare relÃ¨ve de :", options:["Prefet","Pompier (oral)","Astreinte SNCF","CEV"], correctIndex:2 },
  ];

  const $ = (id) => document.getElementById(id);
  let idx = 0, timer = null, timeLeft = TIME_LIMIT;
  const answers = [];
  const resp = { service:"", last:"", first:"" };

  // === FLAMMES (particle emojis) ===
  function launchFlames(durationMs = 1800) {
    const existing = document.getElementById("flameCanvas");
    if (existing) existing.remove();

    const canvas = document.createElement("canvas");
    canvas.id = "flameCanvas";
    canvas.style.position = "fixed";
    canvas.style.inset = "0";
    canvas.style.pointerEvents = "none";
    canvas.style.zIndex = "9999";
    document.body.appendChild(canvas);

    const ctx = canvas.getContext("2d");
    const dpr = Math.max(1, window.devicePixelRatio || 1);

    function resize() {
      canvas.width = Math.floor(window.innerWidth * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    resize();

    const emojis = ["ðŸ”¥","ðŸ”¥","ðŸ”¥","âœ¨"];
    const particles = [];
    const start = performance.now();
    let rafId;

    function spawn() {
      const spawnRate = 16;
      for (let i = 0; i < spawnRate; i++) {
        const size = 16 + Math.random() * 22;
        particles.push({
          x: Math.random() * window.innerWidth,
          y: window.innerHeight + 30 + Math.random() * 30,
          vx: (-0.9 + Math.random() * 1.8),
          vy: -(2.5 + Math.random() * 4.5),
          life: 650 + Math.random() * 800,
          born: performance.now(),
          size,
          rot: (-0.18 + Math.random() * 0.36),
          a: 1,
          emoji: emojis[(Math.random() * emojis.length) | 0],
        });
      }
    }

    function draw(now) {
      const elapsed = now - start;
      ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);

      if (elapsed < durationMs) spawn();

      for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        const age = now - p.born;
        const t = age / p.life;
        p.a = 1 - Math.min(1, Math.max(0, t));

        p.x += p.vx;
        p.y += p.vy;
        p.vy *= 0.995; // petit amorti

        ctx.save();
        ctx.globalAlpha = p.a;
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot * age * 0.01);
        ctx.font = `${p.size}px system-ui, Apple Color Emoji, Segoe UI Emoji`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(p.emoji, 0, 0);
        ctx.restore();

        if (age > p.life || p.y < -80 || p.a <= 0) particles.splice(i, 1);
      }

      if (elapsed < durationMs || particles.length > 0) {
        rafId = requestAnimationFrame(draw);
      } else {
        cancelAnimationFrame(rafId);
        canvas.remove();
        window.removeEventListener("resize", resize);
      }
    }

    window.addEventListener("resize", resize);
    requestAnimationFrame(draw);
  }

  // Affichage du total (Ã©vite le bug "30" alors que la liste change)
  $("totalQ").textContent = QUESTIONS.length;
  $("totalQTop").textContent = QUESTIONS.length;

  function renderQuestion() {
    const q = QUESTIONS[idx];
    $("qIndex").textContent = idx + 1;
    $("questionText").textContent = q.text;

    const container = $("options");
    container.innerHTML = "";
    q.options.forEach((opt, i) => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="radio" name="quizOpt" value="${i}"> ${opt}`;
      container.appendChild(label);
    });

    $("nextBtn").disabled = true;
    container.onchange = () => { $("nextBtn").disabled = false; };
    resetTimer();
  }

  function resetTimer() {
    clearInterval(timer);
    timeLeft = TIME_LIMIT;
    $("timeLeft").textContent = timeLeft;
    $("progress").value = 0;

    timer = setInterval(() => {
      timeLeft--;
      $("timeLeft").textContent = timeLeft;
      $("progress").value = TIME_LIMIT - timeLeft;
      if (timeLeft <= 0) { commitAnswer(true); nextQuestion(); }
    }, 1000);
  }

  function commitAnswer(timedOut = false) {
    const q = QUESTIONS[idx];
    const radios = document.getElementsByName("quizOpt");
    let selected = null;
    for (const r of radios) { if (r.checked) selected = parseInt(r.value, 10); }

    answers.push({
      id: q.id,
      selected,
      isCorrect: selected === q.correctIndex,
      timedOut
    });
  }

  function nextQuestion() {
    idx++;
    if (idx >= QUESTIONS.length) {
      clearInterval(timer);
      $("quizCard").style.display = "none";
      $("finalCard").style.display = "block";
    } else {
      renderQuestion();
    }
  }

  $("serviceOrigin").onchange = () => {
    $("otherServiceWrap").style.display = ($("serviceOrigin").value === "Autre") ? "block" : "none";
  };

  $("startBtn").onclick = () => {
    const s = $("serviceOrigin").value;
    const last = $("lastName").value.trim();
    const first = $("firstName").value.trim();
    const other = $("serviceOther").value.trim();

    if (!s || !last || !first || (s === "Autre" && !other)) {
      $("startWarn").style.display = "block";
      return;
    }
    $("startWarn").style.display = "none";

    resp.service = (s === "Autre") ? other : s;
    resp.last = last;
    resp.first = first;

    $("startCard").style.display = "none";
    $("quizCard").style.display = "block";
    renderQuestion();
  };

  $("nextBtn").onclick = () => { commitAnswer(false); nextQuestion(); };
  $("skipBtn").onclick = () => { commitAnswer(false); nextQuestion(); };

  // âœ… ENVOI COMPATIBLE AVEC TON APPS SCRIPT
  $("sendBtn").onclick = () => {
    $("sendBtn").disabled = true;
    $("sendStatus").textContent = "Envoi des rÃ©sultatsâ€¦";

    const payload = {
      submittedAtISO: new Date().toISOString(),
      startedAtISO: "",
      durationSeconds: "",

      serviceOrigin: resp.service,
      lastName: resp.last,
      firstName: resp.first,

      totalQuestions: QUESTIONS.length,
      answeredCount: answers.filter(a => a.selected !== null && a.selected !== undefined).length,
      correctCount: answers.filter(a => a.isCorrect).length,

      freeText: $("freeText").value || "",
      answers: answers
    };

    try {
      fetch(APPS_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(payload)
      });
    } catch (e) {}

    $("finalCard").style.display = "none";
    $("doneCard").style.display = "block";

    // ðŸ”¥ Effet fin de quiz
    launchFlames(1800);
  };
</script>
</body>
</html>
